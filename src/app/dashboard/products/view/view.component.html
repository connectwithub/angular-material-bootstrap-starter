<div class="container">
  <div class="row">
    <div class="col">
      <div class="row">
        <div class="col-sm-4" *ngFor="let product of productsSub | async | select: 'products'">
          <ng-container *ngTemplateOutlet="productCard;context:{product:product}"></ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #productCard let-product="product">
  <div class="my-3">
    <div class="card hover-shadow hover-border text-white border-0 rounded pointer-none" [ngClass]="{'stacked': product.isBackStacked, 'no-stack':!product.hasOwnProperty('isBackStacked')}">

      <img *ngIf="product.gallery.length>0" [src]="environment.imgServerUrl+product.gallery[0]?.url" class="card-img h-100 w-100 rounded front-content" alt="...">
      <img *ngIf="product.gallery.length==0" src="/assets/img/no-image.png" class="card-img h-100 w-100 rounded front-content" alt="...">

      <ng-container *ngTemplateOutlet="cardFront;context:{product:product}"></ng-container>
      <ng-container *ngTemplateOutlet="cardBack;context:{product:product}"></ng-container>
      <!-- <p class="card-text">{{product.description}}</p> -->
    </div>
  </div>
</ng-template>

<ng-template #cardFront let-product="product">
  <div (click)="product.isBackStacked=true" class="card-img-overlay p-4 d-flex justify-content-center align-items-center flex-column rounded front-content pointer-auto">
    <h5 class="card-title text-center text-capitalize pointer">{{product.name}}<br /> ({{product.productId}})</h5>
    <div class="row">
      <div class="col">
        <span class="float-left text-center">SP <br /><span class="text-primary">{{product.SP | currency:'INR'}}</span></span>
      </div>
      <div class="col">
        <span class="float-right text-center">Tax <br /><span class="text-secondary">{{product.tax||0 }}%</span></span>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #cardBack let-product="product">
  <div class="back-content card-body pointer-auto">
    <ng-container *ngTemplateOutlet="cardMenu;context:{product:product}"></ng-container>
    <div class="container-fluid px-0">
      <div (click)="product.isBackStacked=false" matRipple class="">
        <div class="row text-muted">
          <div class="col h5 text-center text-capitalize">
            <strong>{{product.name}}</strong><br />
            <small>({{product.productId}})</small>
          </div>
        </div>
        <div class="row h6 text-muted my-3">
          <div class="col">
            <div class="row text-primary">
              <div class="col">
                SP:
              </div>
              <div class="col font-weight-bold">
                {{product.SP | currency:'INR'}}
              </div>
            </div>
          </div>
          <div class="col">
            <div class="row">
              <div class="col">
                Tax:
              </div>
              <div class="col">
                {{product.tax ||0 }}%
              </div>
            </div>
          </div>
        </div>
        <div class="row text-muted mt-3">
          <div class="col">
            <span class="h6">Product Description:</span>
            <p class="mt-3 mb-0 small">
              {{product.description | excerpt:20}}..
            </p>
          </div>
        </div>
      </div>
      <hr />
      <button type="button" class="btn btn-outline-primary mx-auto d-block">Know More</button>
    </div>
  </div>
</ng-template>

<ng-template #cardMenu let-product="product">
  <button [matMenuTriggerFor]="menu" class="btn btn-link position-absolute top-0 right-0 rounded-circle" matRipple>
    <fa-icon [icon]="['fas','ellipsis-v']" size="lg"></fa-icon>
  </button>
  <mat-menu #menu="matMenu" [overlapTrigger]="true" xPosition="before">
    <button mat-menu-item>
      <fa-icon [icon]="['fas','project-diagram']" size="lg"></fa-icon>
      <span> View/Set Relation</span>
    </button>
    <button mat-menu-item>
      <fa-icon [icon]="['fas','trash']" size="lg"></fa-icon>
      <span> Delete Product</span>
    </button>
    <button mat-menu-item>
      <fa-icon [icon]="['fas','edit']" size="lg"></fa-icon>
      <span> Edit Product</span>
    </button>
  </mat-menu>
</ng-template>
